/*
--ELIMINAR TABLAS EN ORDEN
DROP TABLE VENTA_DETALLE ;
DROP TABLE VENTA;
DROP TABLE PRODUCTO;
DROP TABLE CATEGORIA;
DROP TABLE PERSONA;
*/

--CREAR LAS TABLAS
CREATE TABLE PERSONA (
    IDPER int  NOT NULL,
    DNIPER char(8)  NOT NULL,
    NOMPER varchar2(50)  NOT NULL,
    APEPER varchar2(50)  NOT NULL,
    EMAPER varchar2(80)  NOT NULL,
    CELPER char(9)  NOT NULL,
    TIPPER char(1)  NOT NULL,
    ESTPER char(1) DEFAULT 'A' NOT NULL,
    FECNACPER DATE NOT NULL,
    CONSTRAINT PERSONA_pk PRIMARY KEY (IDPER)
) ;
CREATE TABLE CATEGORIA(
    IDCAT INT NOT NULL,
    NOMCAT varchar2(50)  NOT NULL,
    CONSTRAINT CATEGORIA_pk PRIMARY KEY (IDCAT)
);

CREATE TABLE PRODUCTO(
    CODPROD varchar2(50)  NOT NULL,
    NOMPRO varchar2(50)  NOT NULL,
    IDCATPRO int NOT NULL,
    PREPRO decimal(8,2)  NOT NULL,
    STOCKPRO int NOT NULL,
    ESTPRO char(1) DEFAULT 'A' NOT NULL,
    CONSTRAINT PRODUCTO_pk PRIMARY KEY (CODPROD)
);

CREATE TABLE VENTA(
    IDVEN INT NOT NULL,
    FECVEN date NOT NULL,
    IDVEND int NOT NULL,
    IDCLI int NOT NULL,
    TIPPAGVEN char(1)  NOT NULL,
    ESTVEN char(1) DEFAULT 'A' NOT NULL,
    CONSTRAINT VENTA_pk PRIMARY KEY (IDVEN)
);

--CREAR LA TABLA  VENTA_DETALLE
CREATE TABLE VENTA_DETALLE(
    IDVENDET INT NOT NULL,
    IDVEN int NOT NULL,
    CODPRO varchar2(50)  NOT NULL,
    CANVENDET NUMBER NOT NULL,
    CONSTRAINT VENTA_DETALLE_pk PRIMARY KEY (IDVENDET)
);
--RELACIONES DE LA TABLAS
ALTER TABLE PRODUCTO ADD CONSTRAINT PRODUCTO_CATEGORIA
    FOREIGN KEY (IDCATPRO)
    REFERENCES CATEGORIA (IDCAT);
    
ALTER TABLE VENTA ADD CONSTRAINT VENTA_VENDEDOR
    FOREIGN KEY (IDVEND)
    REFERENCES PERSONA (IDPER);

ALTER TABLE VENTA ADD CONSTRAINT VENTA_CLIENTE
    FOREIGN KEY (IDCLI)
    REFERENCES PERSONA (IDPER);
    
ALTER TABLE VENTA_DETALLE ADD CONSTRAINT VENTA_DETALLE_VENTA
    FOREIGN KEY (IDVEN)
    REFERENCES VENTA (IDVEN);
    
ALTER TABLE VENTA_DETALLE ADD CONSTRAINT VENTA_DETALLE_PRODUCTO
    FOREIGN KEY (CODPRO)
    REFERENCES PRODUCTO (CODPROD);
    
---SECUENCIAS
CREATE SEQUENCE INC_PER
START WITH 200
INCREMENT BY 1;

CREATE SEQUENCE INC_CAT
START WITH 10
INCREMENT BY 10;

CREATE SEQUENCE INC_VEN
START WITH 1
INCREMENT BY 1;

CREATE SEQUENCE INC_VEN_DET
START WITH 300
INCREMENT BY 1;
---TRIGGERS

CREATE TRIGGER TRG_INC_PER
  BEFORE INSERT ON PERSONA
  FOR EACH ROW
  BEGIN
    SELECT INC_PER.NEXTVAL INTO :NEW.IDPER FROM DUAL;
  END;
  /
  
  CREATE TRIGGER TRG_INC_CAT
  BEFORE INSERT ON CATEGORIA
  FOR EACH ROW
  BEGIN
    SELECT INC_CAT.NEXTVAL INTO :NEW.IDCAT FROM DUAL;
  END;
  /
  
  CREATE TRIGGER TRG_INC_VEN
  BEFORE INSERT ON VENTA
  FOR EACH ROW
  BEGIN
    SELECT INC_VEN.NEXTVAL INTO :NEW.IDVEN FROM DUAL;
  END;
  /
  
  CREATE TRIGGER TRG_INC_VENDET
  BEFORE INSERT ON VENTA_DETALLE
  FOR EACH ROW
  BEGIN
    SELECT INC_VEN_DET.NEXTVAL INTO :NEW.IDVENDET FROM DUAL;
  END;
  /
  
create or replace trigger INSERTAR_FECHA  
 BEFORE insert on VENTA 
 for each row  
 begin
   :NEW.FECVEN := to_char(sysdate, 'DD/MM/YYYY HH24:MI:SS'); 
end;
/

alter SESSION set nls_date_format='DD/MM/YYYY HH24:MI:SS';

--REGISTRO DE LAS TABLA
INSERT ALL
INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,FECNACPER) VALUES ('77889955','Alberto','Solano Pariona','alberto.pariona@empresa.com','998456321','V','10/2/1970')
INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,FECNACPER) VALUES ('45781233','Alicia','Garcia Campos','alicia.garcia@gmail.com','929185236','C','20/3/1980')
INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,FECNACPER) VALUES ('15487922','Juana','Avila Chumpitaz','juana.avila@gmail.com','923568741','C','6/6/1986')
INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,FECNACPER) VALUES ('22116633','Ana','Enriquez Flores','ana.enriquez@empresa.com','978848551','V','10/2/1970')
INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,FECNACPER) VALUES ('88741589','Claudia','Perales Ortiz','claudia.perales@yahoo.com','997845263','C','25/7/1981')
INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,FECNACPER) VALUES ('45122587','Mario','Barrios Martinez','mario.barrios@outlook.com','986525874','C','10/10/1987')
INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,FECNACPER) VALUES ('15258564','Brunela','Tarazona Guerra','brunela.tarazona@gmail.com','986525877','C','6/6/1990')
SELECT * FROM DUAL
COMMIT;
 
INSERT ALL
INTO CATEGORIA(NOMCAT) VALUES('Abarrotes')
INTO CATEGORIA(NOMCAT) VALUES('Carnes y Pollo')
INTO CATEGORIA(NOMCAT) VALUES('Higiene y Limpieza')
SELECT * FROM DUAL
COMMIT;
 
INSERT ALL
INTO PRODUCTO(CODPROD,NOMPRO,PREPRO,STOCKPRO,IDCATPRO) VALUES('P01','Arroz',4.65,50,10)
INTO PRODUCTO(CODPROD,NOMPRO,PREPRO,STOCKPRO,IDCATPRO) VALUES('P02','Azucar',3.45,60,10)
INTO PRODUCTO(CODPROD,NOMPRO,PREPRO,STOCKPRO,IDCATPRO) VALUES('P03','Pollo fresco',8.70,20,20)
INTO PRODUCTO(CODPROD,NOMPRO,PREPRO,STOCKPRO,IDCATPRO) VALUES('P04','Lomo dino',18.50,40,20)
INTO PRODUCTO(CODPROD,NOMPRO,PREPRO,STOCKPRO,IDCATPRO) VALUES('P05','Detergente Opal',8.75,60,30)
INTO PRODUCTO(CODPROD,NOMPRO,PREPRO,STOCKPRO,IDCATPRO) VALUES('P06','Suavizante Ariel',7.85,30,30)
SELECT * FROM DUAL
COMMIT;

INSERT ALL
INTO VENTA(IDVEND,IDCLI,TIPPAGVEN) VALUES(200,202,'E')
INTO VENTA(IDVEND,IDCLI,TIPPAGVEN) VALUES(200,204,'T')
INTO VENTA(IDVEND,IDCLI,TIPPAGVEN) VALUES(203,205,'T')
INTO VENTA(IDVEND,IDCLI,TIPPAGVEN) VALUES(203,206,'E')
SELECT * FROM DUAL
COMMIT;

INSERT ALL
INTO VENTA_DETALLE(IDVEN,CODPRO,CANVENDET) VALUES(1,'P01',2)
INTO VENTA_DETALLE(IDVEN,CODPRO,CANVENDET) VALUES(1,'P04',4)
SELECT * FROM DUAL
COMMIT;